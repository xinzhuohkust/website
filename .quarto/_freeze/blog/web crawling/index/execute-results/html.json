{
  "hash": "047e58fd1a8167d7d1bc2f39bbff9cb2",
  "result": {
    "markdown": "---\ntitle: \"Practical Techniques for Web Scraping\"\ndate: \"Jun 20 2023\"\ncategories: [R, Python, Web Scraping]\ndescription: \"with R and Python\"\ncode-fold: show\nfeed: true\n---\n\n\n![](webscraping.jpg){fig-align=\"center\" width=\"500\"}\n\n### User Agent Switcher\n\n\n::: {.cell}\n\n:::\n\n\nBased on the `Python` project [fake-useragent.](https://pypi.org/project/fake-useragent/){target=\"_blank\"}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nuser_agents <- \"https://raw.githubusercontent.com/fake-useragent/fake-useragent/master/src/fake_useragent/data/browsers.json\" %>% \n  read_html() %>% \n  html_text() %>% \n  str_extract_all(\"\\\\{.+?\\\\}\") %>% \n  pluck(1) %>% \n  map_dfr(~ fromJSON(.) |> as_tibble_row())\n  \nnrow(user_agents) # there are 52 user agents in total\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 52\n```\n:::\n:::\n\n\n<br> Get a fake user agent randomly.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsample_n(user_agents, 1) %>% \n  select(useragent)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|useragent                                                                                                                         |\n|:---------------------------------------------------------------------------------------------------------------------------------|\n|Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36 Edg/116.0.1938.81 |\n\n</div>\n:::\n:::\n\n\n<br>\n\n### Application: web scraper for the landchina.com\n\n\n::: {.cell}\n\n```{.r .cell-code}\nextract_land_info <- possibly(\n    function(id) {\n        info <- \"https://api.landchina.com/tGdxm/result/detail\" %>%\n            request() %>%\n            req_headers(\"user-agent\" = sample_n(user_agents, 1)$useragent) %>%# <1>\n            req_timeout(12) %>%\n            req_proxy(\"yourproxy\", 2023) %>%\n            req_retry(\n              max_tries = 5,              \n              max_seconds = 30,\n              is_transient = ~5\n            ) %>%\n            req_body_json(\n                list(\"gdGuid\" = id),\n                unbox = TRUE\n            ) %>%\n            req_perform() %>%\n            pluck(\"body\") %>% \n            read_html() %>%\n            html_text()\n\n        if (str_detect(info, id)) {\n            return(info)\n        } else {\n            return(\"error!\")\n        }\n    },\n    otherwise = \"error!\"\n) # web scraper using httr2\n```\n:::\n\n1. User agent switcher\n\n\n::: {.cell}\n\n```{.r .cell-code}\nextract_land_info(\"48BF016EBDD6409FA4622466C964D869\")\n```\n:::\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"{\\\"msg\\\":\\\"操作成功\\\",\\\"code\\\":200,\\\"relate\\\":[{\\\"stage\\\":3,\\\"showStage\\\":3,\\\"gdGuid\\\":\\\"48BF016EBDD6409FA4622466C964D869\\\",\\\"zdZl\\\":\\\"台北路1号\\\\n\\\",\\\"cjJg\\\":2100,\\\"gyFs\\\":\\\"协议出让\\\"}],\\\"data\\\":{\\\"province\\\":\\\"山东省\\\",\\\"city\\\":\\\"青岛市本级\\\",\\\"xzqFullName\\\":\\\"山东省青岛市本级\\\",\\\"tdLy\\\":\\\"新增建设用地(来自存量库)\\\",\\\"gdGuid\\\":\\\"48BF016EBDD6409FA4622466C964D869\\\",\\\"xzqDm\\\":\\\"370200000\\\",\\\"tdJb\\\":\\\"二级\\\",\\\"tdZl\\\":\\\"台北路1号\\\\n\\\",\\\"gdZmj\\\":0.2613,\\\"gyFs\\\":\\\"协议出让\\\",\\\"xzMj\\\":0,\\\"clMj\\\":0.2613,\\\"je\\\":2100,\\\"qdRq\\\":1169568000000,\\\"pzJg\\\":\\\"07-7\\\\n\\\",\\\"xmCj\\\":0},\\\"payAgree\\\":[]}\"\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}