{"title":"Causal Inference Practical Methods","markdown":{"yaml":{"title":"Causal Inference Practical Methods","date":"May 15, 2023","categories":["R","DiD","RD","IV","Causal Inference"],"description":"with R","code-fold":"show","feed":true,"cap-location":"bottom"},"headingText":"Setup","headingAttr":{"id":"","classes":["unnumbered"],"keyvalue":[]},"containsRefs":false,"markdown":"\n\n```{=html}\n<style>\nbody {text-align: justify}\n</style>\n```\n\n```{r}\n#| message: false\n#| warning: false\nrequire(\"pacman\")\n\np_load(\n    tibble, dplyr, furrr, purrr, tidyr, stringr, rio, ggplot2, knitr, broom, kableExtra, lfe, plm, ggthemes, skimr, ggpmisc, AER, dagitty, ggdag, rdrobust, rddensity, did\n)\n\nprint_kable <- \\(result, title) {\n    kable(\n        result,\n        digits = 3,\n        caption = title,\n        booktabs = TRUE\n    )\n}\n```\n\n```{r}\n#| echo: false\n#| output: false\nviridisLite::viridis(8, option = \"plasma\", begin = 0.1, end = 0.9)\n```\n\n# Fixed Effects\n\n## Linear Dummy Variabel Model\n\nFixed effects model shows that the beer tax does reduce fatalities.\n\n```{r}\n#| message: false\n#| warning: false\n#| fig-cap: \"The relationship between the beer tax and fatality\"\n#| cap-location: top\nfatality <- import(\n    \"E:/OneDrive - HKUST Connect/assignment/assignment3/fatality.csv\",\n    setclass = \"tibble\"\n)\n\nfatality %>%\n    ggplot(aes(x = beertax, y = fatality_rate)) +\n    geom_point(aes(color = state), size = 2.3) +\n    geom_smooth(\n        aes(group = state, color = state),\n        method = \"lm\",\n        se = FALSE\n    ) +\n    geom_smooth(method = \"lm\", linetype = \"dashed\", color = \"#8E8E93\") +\n    xlab(\"Beer Tax\") +\n    ylab(\"Fatalities\") +\n    ggthemes::theme_hc() +\n    theme(panel.grid.minor = element_blank(), legend.position = \"none\")\n```\n\n```{r}\n#| message: false\n#| warning: false\nlinear_dummy_formula <- fatality %>%\n    pull(state) %>%\n    sprintf(\"`%s`\", .) %>%\n    unique() %>%\n    str_c(collapse = \" + \") %>%\n    str_c(\"fatality_rate ~ 0 + beertax + \", ., collapse = \" + \") %>%\n    as.formula()\n\nlinear_dummy <- fatality %>%\n    pivot_wider(\n        names_from = state,\n        values_from = state\n    ) %>%\n    mutate(\n        across(3:50, ~ str_replace(., \"\\\\w+\", \"1\")),\n        across(3:50, ~ replace_na(., \"0\")),\n        across(3:50, as.numeric)\n    ) %>%\n    lm(\n        linear_dummy_formula,\n        data = .\n    )\n\nlinear_dummy %>%\n    tidy() %>%\n    slice(1) %>%\n    print_kable(title = \"Linear dummy variable model\")\n```\n\n## Fixed effect in standard packages\n\n```{r}\n#| message: false\n#| warning: false\nfixed_effect_plm <- fatality %>%\n    pdata.frame(index = c(\"state\")) %>%\n    plm(\n        fatality_rate ~ beertax,\n        data = .,\n        model = \"within\",\n        effect = \"individual\"\n    )\n\nfixed_clustered_plm <- fixed_effect_plm %>%\n    tidy() %>%\n    mutate(\n        category = \"fixed effects with plm\",\n        `std.error` = vcovHC(\n            fixed_effect_plm,\n            type = \"HC1\",\n            cluster = \"group\"\n        ) |>\n            diag() |>\n            sqrt(),\n        statistic = coef(fixed_effect_plm) / `std.error`,\n        `p.value` = 2 * pt(\n            abs(statistic),\n            df = fixed_effect_plm$df.residual,\n            lower.tail = FALSE\n        )\n    )\n\nfixed_clustered_lfe <- fatality %>%\n    felm(\n        fatality_rate ~ beertax | state,\n        cluster = \"state\",\n        data = .\n    ) %>%\n    tidy() %>%\n    mutate(category = \"fixed effects with lfe\")\n\nfixed_clustered_lfe %>%\n    bind_rows(fixed_clustered_plm) %>%\n    print_kable(title = \"Fixed effect in standard packages\")\n```\n\n# DiD\n\n## Pre-trends\n\nBased on the figure, the parallel trend assumption may not hold, as we can see that the crime rates in Muslim/Jewish neighborhoods experienced two episodes of first decreasing, then increasing again, before increasing prior to the intervention. However, the Non Muslim/Jewish only experienced one episodes.\n\n```{r}\n#| message: false\n#| warning: false\n#| fig-cap: \"Pre-trends test\"\ncartheft <- import(\n    \"E:/OneDrive - HKUST Connect/assignment/assignment3/cartheft.dta\",\n    setclass = \"tibble\"\n) %>%\n    mutate(treatment = if_else(distance > 0, 0, 1))\n\ncartheft %>%\n    group_by(month, treatment, postattack) %>%\n    summarise(mean = mean(cartheft)) %>%\n    ggplot(\n        aes(x = month, y = mean)\n    ) +\n    geom_line(\n        aes(group = treatment, color = as.factor(treatment)),\n        linewidth = 1.2,\n        linetype = \"twodash\"\n    ) +\n    geom_vline(\n        xintercept = 8,\n        linetype = \"dotdash\",\n        linewidth = 1,\n        color = \"#8E8E93\"\n    ) +\n    ggthemes::theme_hc() +\n    xlab(\"Month\") +\n    ylab(\"Mean crime rates\") +\n    theme(\n        legend.position = \"none\"\n    ) +\n    geom_text(\n        x = 10,\n        y = 0.064,\n        label = \"Muslim/Jewish\",\n        size = 3.6,\n        fontface = \"italic\"\n    ) +\n    geom_text(\n        x = 10,\n        y = 0.112,\n        label = \"Non Muslim/Jewish\",\n        size = 3.6,\n        fontface = \"italic\"\n    )\n```\n\n## DiD as a linear regression with interaction\n\n```{r}\n#| message: false\n#| warning: false\ndid_interaction <- cartheft %>%\n    lm(\n        cartheft ~ treatment + postattack + treatment * postattack,\n        data = .\n    ) %>%\n    tidy() %>%\n    slice(4) %>%\n    mutate(term = \"Same-Block Police\")\n\ndid_interaction %>%\n    print_kable(., title = \"linear regression with interaction\")\n```\n\n## DiD asd fixed effect\n\n```{r}\n#| message: false\n#| warning: false\ndid_fixed <- cartheft %>%\n    felm(\n        cartheft ~ treatment * postattack | blockid + month,\n        data = .\n    ) %>%\n    tidy() %>%\n    slice(3) %>%\n    mutate(term = \"Same-Block * Postattack\")\n\ndid_fixed %>%\n    print_kable(title = \"Two way fixed effect model\")\n```\n\n## Time-invariant variables in fixed effect regressions\n\nWe cannot estimate the coefficient for time-invariant variables since they are absorbed by the individual fixed effects.\n\n```{r}\n#| message: false\n#| warning: false\ndid_fixed_invariant <- cartheft %>%\n    felm(\n        cartheft ~ treatment * postattack + bank | blockid + month,\n        data = .\n    ) %>%\n    tidy() %>%\n    slice(3:4) %>%\n    mutate(term = c(\"Bank\", \"Same-Block * Postattack\"))\n\ndid_fixed_invariant %>%\n    print_kable(title = \"Time-invariant variables in regression\")\n```\n\n# Instrumental Variable\n\n```{=tex}\n\\begin{align*}\n\\log(wage) = \\beta_{0} + \\beta_{1}educ\n\\end{align*}\n```\n```{=tex}\n\\begin{align*}                \neduc = \\gamma_{0} + \\gamma_{1}educ\n\\end{align*}\n```\n## IV estimate\n\nThe IV estimator is larger than the OLS estimator. Since in this study, IV is used to address endogeneity by providing a source of variation in the predictor variable that is independent of the error term. In that case, IV estimate accounts for endogeneity and provides a more reliable estimate of the true causal effect of the predictor variable on the outcome variable. The OLS estimate, on the other hand, may be biased and inconsistent in the presence of endogeneity, leading to an underestimate of the true effect size.\n\n```{r}\n#| message: false\n#| warning: false\n#| fig-cap: \"Directed Acyclic Graphs\"\ndag <- tribble(\n    ~name, ~label, ~x, ~y,\n    \"educ\", \"Educ\", 4, 1,\n    \"wage\", \"Wage\", 5, 1,\n    \"e\", \"Confounders\", 4.5, 1.5,\n    \"Z\", \"Instrumental Variable\", 3, 1\n)\n\nnode_labels <- dag$label\nnames(node_labels) <- dag$name\n\nstatus_colors <- c(\n    exposure = \"#00BFFF\",\n    outcome = \"#FF7F50\",\n    latent = \"#D3D3D3\"\n)\n\ndagify(\n    wage ~ educ + e,\n    educ ~ e,\n    educ ~ Z,\n    exposure = \"educ\",\n    outcome = \"wage\",\n    latent = \"e\",\n    coords = dag,\n    labels = node_labels\n) %>%\n    tidy_dagitty() %>%\n    node_status() %>%\n    ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +\n    geom_dag_edges() +\n    geom_dag_point(aes(color = status)) +\n    geom_dag_label_repel(\n        aes(label = label, fill = status),\n        color = \"white\",\n        fontface = \"bold\"\n    ) +\n    scale_color_manual(values = status_colors, na.value = \"grey20\") +\n    scale_fill_manual(values = status_colors, na.value = \"grey20\") +\n    guides(color = FALSE, fill = FALSE) +\n    theme_dag()\n```\n\n```{r}\n#| message: false\n#| warning: false\ncard <- import(\n    \"E:/OneDrive - HKUST Connect/assignment/assignment3/card.csv\",\n    setclass = \"tibble\"\n)\n\nols <- card %>%\n    lm(\n        lwage ~ educ,\n        data = .\n    ) %>%\n    coeftest(vcovHC, \"HC1\") %>%\n    tidy() %>%\n    slice(2) %>%\n    mutate(method = \"OLS with robust std.error\")\n\niv <- card %>%\n    ivreg(\n        lwage ~ educ | nearc4,\n        data = .\n    ) %>%\n    coeftest(vcovHC, \"HC1\") %>%\n    tidy() %>%\n    slice(2) %>%\n    mutate(method = \"IV with robust std.error\")\n\nbind_rows(ols, iv) %>%\n    print_kable(title = \"Comparison between OLS and IV\")\n```\n\n## Manual 2SLS\n\n```{r}\n#| message: false\n#| warning: false\nfirst_stage <- card %>%\n    lm(\n        educ ~ nearc4,\n        data = .\n    )\n\nmanual <- card %>%\n    mutate(educ = predict(first_stage)) %>%\n    lm(\n        lwage ~ educ,\n        data = .\n    ) %>%\n    coeftest(vcovHC, \"HC1\") %>%\n    tidy() %>%\n    slice(2) %>%\n    mutate(method = \"Manual 2SLS with robust std.error\")\n\nbind_rows(manual, iv, ols) %>%\n    print_kable(title = \"Comparison between OLS, IV and manual 2SLS\")\n```\n\n## Weak instrument\n\nThe F statistics from the first-stage regression is larger than 10.\n\n```{r}\n#| message: false\n#| warning: false\nwaldtest(\n    lm(lwage ~ educ + nearc4, card),\n    lm(lwage ~ educ, card)\n) %>%\n    tidy() %>%\n    rename(F.statistic = statistic) %>%\n    print_kable(title = \"Weak instrument test\")\n```\n\n## Interpretation of effect\n\n-   Compliers are the individuals whose decision to attend college is influenced by the instrumental variable. In this study, compliers are the students who would attend college if they lived close to one and would not attend college if they lived far away. These students' decisions are directly impacted by the geographical distance to college.\n-   Always-takers are the individuals who would attend college regardless of the geographical distance. These students would pursue higher education even if they lived far away from a college.\n\n# Sharp RD\n\n## RD plot\n\nWe can observe a clear difference around the cutoff.\n\n```{r}\n#| message: false\n#| warning: false\n#| fig-cap: \"Raw RD plot\"\nsenate <- import(\n    \"E:/OneDrive - HKUST Connect/assignment/assignment3/senate.csv\",\n    setclass = \"tibble\"\n) %>%\n    mutate(cutoff = if_else(margin > 0, 1, 0))\n\nsenate %>% \n    mutate(across(everything(), ~ round(., 2))) %>% \n    DT::datatable()\n\nsenate %>%\n    ggplot(aes(x = margin, y = vote, color = as.factor(cutoff))) +\n    geom_point(\n        size = 1,\n        alpha = 0.5,\n        position = position_jitter(\n            width = 0,\n            height = 0.25\n        )\n    ) +\n    geom_smooth(\n        data = filter(senate, margin > 0),\n        aes(x = margin, y = vote),\n        method = \"lm\",\n        color = \"#8E8E93\"\n    ) +\n    geom_smooth(\n        data = filter(senate, margin < 0),\n        aes(x = margin, y = vote),\n        method = \"lm\",\n        color = \"#8E8E93\"\n    ) +\n    scale_color_manual(values = c(\"#FF7F50\", \"#00BFFF\")) +\n    geom_vline(\n        xintercept = 0,\n        linetype = \"dotdash\",\n        linewidth = 1\n    ) +\n    ggthemes::theme_hc() +\n    theme(\n        legend.position = \"none\"\n    ) +\n    xlab(\"Winning margin of a Democratic party senator\") +\n    ylab(\"Share of vote of the senator in election\")\n```\n\n```{r}\n#| message: false\n#| warning: false\n#| fig-cap: \"Binned RD plot\"\nrdplot(\n    y = senate$vote,\n    x = senate$margin,\n    nbins = 10,\n    x.label = \"Winning margin of a Democratic party senator\",\n    y.label = \"Share of vote of the senator in election\",\n    title = \"\"\n)\n```\n\n## Density Test\n\n```{r}\n#| message: false\n#| warning: false\n#| fig-cap: \"Density Test\"\ndensity_plot <- rddensity(\n    senate$margin,\n    c = 0\n) %>%\n    rdplotdensity(\n        rdd = .,\n        X = senate$margin,\n        type = \"both\"\n    ) %>%\n    pluck(\"Estplot\")\n```\n\n## RD bandwidth selection\n\nThe obtained bandwidth is 24.969. We estimate the RD effect using three different bandwidth values (ideal, twice the ideal, and half of the ideal) to determine if the value is appropriate. As we can see, the coefficients change substantially. It is considered a big bandwidth since it includes more observations in our analysis.\n\n```{r}\n#| message: false\n#| warning: false\nrdbwselect(\n    y = senate$vote,\n    x = senate$margin,\n    c = 0,\n    p = 3,\n    kernel = \"triangular\",\n    bwselect = \"mserd\"\n) %>%\n    pluck(\"bws\") %>%\n    as_tibble() %>%\n    set_names(\n        c(\"BW est left\", \"BW est right\", \"BW bias left\", \"BW bias right\")\n    ) %>%\n    print_kable(title = \"RD bandwidth selection\")\n```\n\n```{r}\n#| message: false\n#| warning: false\nrd_models <- c(24.969, 24.969 * 2, 24.969 / 2) %>%\n    map(~ rdrobust(\n        y = senate$vote,\n        x = senate$margin,\n        p = 3,\n        h = .\n    ))\n\nextract_se_es <- \\(x) {\n    tibble(\n        \"Estimate\" = pluck(x, \"Estimate\")[1],\n        \"Se\" = pluck(x, \"se\")[1],\n        \"P-Value\" = pluck(x, \"pv\")[1]\n    )\n}\n\nrd_models %>%\n    map_dfr(extract_se_es) %>%\n    mutate(\n        Bandwidth = c(\n            \"24.969 (ideal)\",\n            \"49.938 (twice)\",\n            \"12.485 (half)\"\n        ),\n        .before = 1\n    ) %>%\n    print_kable(title = \"Sensitivity analysis using different bandwidths\")\n```\n\n## Estimate Sharp RD treatment effect\n\nThe model result shows that there is an incumbency advantage.\n\n```{r}\n#| message: false\n#| warning: false\nsharp_rd <- rdrobust(\n    y = senate$vote,\n    x = senate$margin,\n    h = 24.96899,\n    p = 3\n)\n\ntibble(\n    \"Estimate\" = pluck(sharp_rd, \"Estimate\")[1],\n    \"Se\" = pluck(sharp_rd, \"se\")[1],\n    \"P-Value\" = pluck(sharp_rd, \"pv\")[1]\n) %>%\n    print_kable(title = \"Sharp RD treatment effect\")\n```\n\n## Varying orders of polynomial regression\n\nModels with different bandwidth all support the same conclusion.\n\n```{r}\n#| message: false\n#| warning: false\nc(1:4) %>%\n    map(~ rdrobust(\n        y = senate$vote,\n        x = senate$margin,\n        p = .,\n        h = 24.96899\n    )) %>%\n    map_dfr(extract_se_es) %>%\n    mutate(\n        `Local-polynomial` = 1:4,\n        .before = 1\n    ) %>%\n    print_kable(\"Varying orders of polynomial regression\")\n```\n","srcMarkdownNoYaml":"\n\n```{=html}\n<style>\nbody {text-align: justify}\n</style>\n```\n# Setup {.unnumbered}\n\n```{r}\n#| message: false\n#| warning: false\nrequire(\"pacman\")\n\np_load(\n    tibble, dplyr, furrr, purrr, tidyr, stringr, rio, ggplot2, knitr, broom, kableExtra, lfe, plm, ggthemes, skimr, ggpmisc, AER, dagitty, ggdag, rdrobust, rddensity, did\n)\n\nprint_kable <- \\(result, title) {\n    kable(\n        result,\n        digits = 3,\n        caption = title,\n        booktabs = TRUE\n    )\n}\n```\n\n```{r}\n#| echo: false\n#| output: false\nviridisLite::viridis(8, option = \"plasma\", begin = 0.1, end = 0.9)\n```\n\n# Fixed Effects\n\n## Linear Dummy Variabel Model\n\nFixed effects model shows that the beer tax does reduce fatalities.\n\n```{r}\n#| message: false\n#| warning: false\n#| fig-cap: \"The relationship between the beer tax and fatality\"\n#| cap-location: top\nfatality <- import(\n    \"E:/OneDrive - HKUST Connect/assignment/assignment3/fatality.csv\",\n    setclass = \"tibble\"\n)\n\nfatality %>%\n    ggplot(aes(x = beertax, y = fatality_rate)) +\n    geom_point(aes(color = state), size = 2.3) +\n    geom_smooth(\n        aes(group = state, color = state),\n        method = \"lm\",\n        se = FALSE\n    ) +\n    geom_smooth(method = \"lm\", linetype = \"dashed\", color = \"#8E8E93\") +\n    xlab(\"Beer Tax\") +\n    ylab(\"Fatalities\") +\n    ggthemes::theme_hc() +\n    theme(panel.grid.minor = element_blank(), legend.position = \"none\")\n```\n\n```{r}\n#| message: false\n#| warning: false\nlinear_dummy_formula <- fatality %>%\n    pull(state) %>%\n    sprintf(\"`%s`\", .) %>%\n    unique() %>%\n    str_c(collapse = \" + \") %>%\n    str_c(\"fatality_rate ~ 0 + beertax + \", ., collapse = \" + \") %>%\n    as.formula()\n\nlinear_dummy <- fatality %>%\n    pivot_wider(\n        names_from = state,\n        values_from = state\n    ) %>%\n    mutate(\n        across(3:50, ~ str_replace(., \"\\\\w+\", \"1\")),\n        across(3:50, ~ replace_na(., \"0\")),\n        across(3:50, as.numeric)\n    ) %>%\n    lm(\n        linear_dummy_formula,\n        data = .\n    )\n\nlinear_dummy %>%\n    tidy() %>%\n    slice(1) %>%\n    print_kable(title = \"Linear dummy variable model\")\n```\n\n## Fixed effect in standard packages\n\n```{r}\n#| message: false\n#| warning: false\nfixed_effect_plm <- fatality %>%\n    pdata.frame(index = c(\"state\")) %>%\n    plm(\n        fatality_rate ~ beertax,\n        data = .,\n        model = \"within\",\n        effect = \"individual\"\n    )\n\nfixed_clustered_plm <- fixed_effect_plm %>%\n    tidy() %>%\n    mutate(\n        category = \"fixed effects with plm\",\n        `std.error` = vcovHC(\n            fixed_effect_plm,\n            type = \"HC1\",\n            cluster = \"group\"\n        ) |>\n            diag() |>\n            sqrt(),\n        statistic = coef(fixed_effect_plm) / `std.error`,\n        `p.value` = 2 * pt(\n            abs(statistic),\n            df = fixed_effect_plm$df.residual,\n            lower.tail = FALSE\n        )\n    )\n\nfixed_clustered_lfe <- fatality %>%\n    felm(\n        fatality_rate ~ beertax | state,\n        cluster = \"state\",\n        data = .\n    ) %>%\n    tidy() %>%\n    mutate(category = \"fixed effects with lfe\")\n\nfixed_clustered_lfe %>%\n    bind_rows(fixed_clustered_plm) %>%\n    print_kable(title = \"Fixed effect in standard packages\")\n```\n\n# DiD\n\n## Pre-trends\n\nBased on the figure, the parallel trend assumption may not hold, as we can see that the crime rates in Muslim/Jewish neighborhoods experienced two episodes of first decreasing, then increasing again, before increasing prior to the intervention. However, the Non Muslim/Jewish only experienced one episodes.\n\n```{r}\n#| message: false\n#| warning: false\n#| fig-cap: \"Pre-trends test\"\ncartheft <- import(\n    \"E:/OneDrive - HKUST Connect/assignment/assignment3/cartheft.dta\",\n    setclass = \"tibble\"\n) %>%\n    mutate(treatment = if_else(distance > 0, 0, 1))\n\ncartheft %>%\n    group_by(month, treatment, postattack) %>%\n    summarise(mean = mean(cartheft)) %>%\n    ggplot(\n        aes(x = month, y = mean)\n    ) +\n    geom_line(\n        aes(group = treatment, color = as.factor(treatment)),\n        linewidth = 1.2,\n        linetype = \"twodash\"\n    ) +\n    geom_vline(\n        xintercept = 8,\n        linetype = \"dotdash\",\n        linewidth = 1,\n        color = \"#8E8E93\"\n    ) +\n    ggthemes::theme_hc() +\n    xlab(\"Month\") +\n    ylab(\"Mean crime rates\") +\n    theme(\n        legend.position = \"none\"\n    ) +\n    geom_text(\n        x = 10,\n        y = 0.064,\n        label = \"Muslim/Jewish\",\n        size = 3.6,\n        fontface = \"italic\"\n    ) +\n    geom_text(\n        x = 10,\n        y = 0.112,\n        label = \"Non Muslim/Jewish\",\n        size = 3.6,\n        fontface = \"italic\"\n    )\n```\n\n## DiD as a linear regression with interaction\n\n```{r}\n#| message: false\n#| warning: false\ndid_interaction <- cartheft %>%\n    lm(\n        cartheft ~ treatment + postattack + treatment * postattack,\n        data = .\n    ) %>%\n    tidy() %>%\n    slice(4) %>%\n    mutate(term = \"Same-Block Police\")\n\ndid_interaction %>%\n    print_kable(., title = \"linear regression with interaction\")\n```\n\n## DiD asd fixed effect\n\n```{r}\n#| message: false\n#| warning: false\ndid_fixed <- cartheft %>%\n    felm(\n        cartheft ~ treatment * postattack | blockid + month,\n        data = .\n    ) %>%\n    tidy() %>%\n    slice(3) %>%\n    mutate(term = \"Same-Block * Postattack\")\n\ndid_fixed %>%\n    print_kable(title = \"Two way fixed effect model\")\n```\n\n## Time-invariant variables in fixed effect regressions\n\nWe cannot estimate the coefficient for time-invariant variables since they are absorbed by the individual fixed effects.\n\n```{r}\n#| message: false\n#| warning: false\ndid_fixed_invariant <- cartheft %>%\n    felm(\n        cartheft ~ treatment * postattack + bank | blockid + month,\n        data = .\n    ) %>%\n    tidy() %>%\n    slice(3:4) %>%\n    mutate(term = c(\"Bank\", \"Same-Block * Postattack\"))\n\ndid_fixed_invariant %>%\n    print_kable(title = \"Time-invariant variables in regression\")\n```\n\n# Instrumental Variable\n\n```{=tex}\n\\begin{align*}\n\\log(wage) = \\beta_{0} + \\beta_{1}educ\n\\end{align*}\n```\n```{=tex}\n\\begin{align*}                \neduc = \\gamma_{0} + \\gamma_{1}educ\n\\end{align*}\n```\n## IV estimate\n\nThe IV estimator is larger than the OLS estimator. Since in this study, IV is used to address endogeneity by providing a source of variation in the predictor variable that is independent of the error term. In that case, IV estimate accounts for endogeneity and provides a more reliable estimate of the true causal effect of the predictor variable on the outcome variable. The OLS estimate, on the other hand, may be biased and inconsistent in the presence of endogeneity, leading to an underestimate of the true effect size.\n\n```{r}\n#| message: false\n#| warning: false\n#| fig-cap: \"Directed Acyclic Graphs\"\ndag <- tribble(\n    ~name, ~label, ~x, ~y,\n    \"educ\", \"Educ\", 4, 1,\n    \"wage\", \"Wage\", 5, 1,\n    \"e\", \"Confounders\", 4.5, 1.5,\n    \"Z\", \"Instrumental Variable\", 3, 1\n)\n\nnode_labels <- dag$label\nnames(node_labels) <- dag$name\n\nstatus_colors <- c(\n    exposure = \"#00BFFF\",\n    outcome = \"#FF7F50\",\n    latent = \"#D3D3D3\"\n)\n\ndagify(\n    wage ~ educ + e,\n    educ ~ e,\n    educ ~ Z,\n    exposure = \"educ\",\n    outcome = \"wage\",\n    latent = \"e\",\n    coords = dag,\n    labels = node_labels\n) %>%\n    tidy_dagitty() %>%\n    node_status() %>%\n    ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +\n    geom_dag_edges() +\n    geom_dag_point(aes(color = status)) +\n    geom_dag_label_repel(\n        aes(label = label, fill = status),\n        color = \"white\",\n        fontface = \"bold\"\n    ) +\n    scale_color_manual(values = status_colors, na.value = \"grey20\") +\n    scale_fill_manual(values = status_colors, na.value = \"grey20\") +\n    guides(color = FALSE, fill = FALSE) +\n    theme_dag()\n```\n\n```{r}\n#| message: false\n#| warning: false\ncard <- import(\n    \"E:/OneDrive - HKUST Connect/assignment/assignment3/card.csv\",\n    setclass = \"tibble\"\n)\n\nols <- card %>%\n    lm(\n        lwage ~ educ,\n        data = .\n    ) %>%\n    coeftest(vcovHC, \"HC1\") %>%\n    tidy() %>%\n    slice(2) %>%\n    mutate(method = \"OLS with robust std.error\")\n\niv <- card %>%\n    ivreg(\n        lwage ~ educ | nearc4,\n        data = .\n    ) %>%\n    coeftest(vcovHC, \"HC1\") %>%\n    tidy() %>%\n    slice(2) %>%\n    mutate(method = \"IV with robust std.error\")\n\nbind_rows(ols, iv) %>%\n    print_kable(title = \"Comparison between OLS and IV\")\n```\n\n## Manual 2SLS\n\n```{r}\n#| message: false\n#| warning: false\nfirst_stage <- card %>%\n    lm(\n        educ ~ nearc4,\n        data = .\n    )\n\nmanual <- card %>%\n    mutate(educ = predict(first_stage)) %>%\n    lm(\n        lwage ~ educ,\n        data = .\n    ) %>%\n    coeftest(vcovHC, \"HC1\") %>%\n    tidy() %>%\n    slice(2) %>%\n    mutate(method = \"Manual 2SLS with robust std.error\")\n\nbind_rows(manual, iv, ols) %>%\n    print_kable(title = \"Comparison between OLS, IV and manual 2SLS\")\n```\n\n## Weak instrument\n\nThe F statistics from the first-stage regression is larger than 10.\n\n```{r}\n#| message: false\n#| warning: false\nwaldtest(\n    lm(lwage ~ educ + nearc4, card),\n    lm(lwage ~ educ, card)\n) %>%\n    tidy() %>%\n    rename(F.statistic = statistic) %>%\n    print_kable(title = \"Weak instrument test\")\n```\n\n## Interpretation of effect\n\n-   Compliers are the individuals whose decision to attend college is influenced by the instrumental variable. In this study, compliers are the students who would attend college if they lived close to one and would not attend college if they lived far away. These students' decisions are directly impacted by the geographical distance to college.\n-   Always-takers are the individuals who would attend college regardless of the geographical distance. These students would pursue higher education even if they lived far away from a college.\n\n# Sharp RD\n\n## RD plot\n\nWe can observe a clear difference around the cutoff.\n\n```{r}\n#| message: false\n#| warning: false\n#| fig-cap: \"Raw RD plot\"\nsenate <- import(\n    \"E:/OneDrive - HKUST Connect/assignment/assignment3/senate.csv\",\n    setclass = \"tibble\"\n) %>%\n    mutate(cutoff = if_else(margin > 0, 1, 0))\n\nsenate %>% \n    mutate(across(everything(), ~ round(., 2))) %>% \n    DT::datatable()\n\nsenate %>%\n    ggplot(aes(x = margin, y = vote, color = as.factor(cutoff))) +\n    geom_point(\n        size = 1,\n        alpha = 0.5,\n        position = position_jitter(\n            width = 0,\n            height = 0.25\n        )\n    ) +\n    geom_smooth(\n        data = filter(senate, margin > 0),\n        aes(x = margin, y = vote),\n        method = \"lm\",\n        color = \"#8E8E93\"\n    ) +\n    geom_smooth(\n        data = filter(senate, margin < 0),\n        aes(x = margin, y = vote),\n        method = \"lm\",\n        color = \"#8E8E93\"\n    ) +\n    scale_color_manual(values = c(\"#FF7F50\", \"#00BFFF\")) +\n    geom_vline(\n        xintercept = 0,\n        linetype = \"dotdash\",\n        linewidth = 1\n    ) +\n    ggthemes::theme_hc() +\n    theme(\n        legend.position = \"none\"\n    ) +\n    xlab(\"Winning margin of a Democratic party senator\") +\n    ylab(\"Share of vote of the senator in election\")\n```\n\n```{r}\n#| message: false\n#| warning: false\n#| fig-cap: \"Binned RD plot\"\nrdplot(\n    y = senate$vote,\n    x = senate$margin,\n    nbins = 10,\n    x.label = \"Winning margin of a Democratic party senator\",\n    y.label = \"Share of vote of the senator in election\",\n    title = \"\"\n)\n```\n\n## Density Test\n\n```{r}\n#| message: false\n#| warning: false\n#| fig-cap: \"Density Test\"\ndensity_plot <- rddensity(\n    senate$margin,\n    c = 0\n) %>%\n    rdplotdensity(\n        rdd = .,\n        X = senate$margin,\n        type = \"both\"\n    ) %>%\n    pluck(\"Estplot\")\n```\n\n## RD bandwidth selection\n\nThe obtained bandwidth is 24.969. We estimate the RD effect using three different bandwidth values (ideal, twice the ideal, and half of the ideal) to determine if the value is appropriate. As we can see, the coefficients change substantially. It is considered a big bandwidth since it includes more observations in our analysis.\n\n```{r}\n#| message: false\n#| warning: false\nrdbwselect(\n    y = senate$vote,\n    x = senate$margin,\n    c = 0,\n    p = 3,\n    kernel = \"triangular\",\n    bwselect = \"mserd\"\n) %>%\n    pluck(\"bws\") %>%\n    as_tibble() %>%\n    set_names(\n        c(\"BW est left\", \"BW est right\", \"BW bias left\", \"BW bias right\")\n    ) %>%\n    print_kable(title = \"RD bandwidth selection\")\n```\n\n```{r}\n#| message: false\n#| warning: false\nrd_models <- c(24.969, 24.969 * 2, 24.969 / 2) %>%\n    map(~ rdrobust(\n        y = senate$vote,\n        x = senate$margin,\n        p = 3,\n        h = .\n    ))\n\nextract_se_es <- \\(x) {\n    tibble(\n        \"Estimate\" = pluck(x, \"Estimate\")[1],\n        \"Se\" = pluck(x, \"se\")[1],\n        \"P-Value\" = pluck(x, \"pv\")[1]\n    )\n}\n\nrd_models %>%\n    map_dfr(extract_se_es) %>%\n    mutate(\n        Bandwidth = c(\n            \"24.969 (ideal)\",\n            \"49.938 (twice)\",\n            \"12.485 (half)\"\n        ),\n        .before = 1\n    ) %>%\n    print_kable(title = \"Sensitivity analysis using different bandwidths\")\n```\n\n## Estimate Sharp RD treatment effect\n\nThe model result shows that there is an incumbency advantage.\n\n```{r}\n#| message: false\n#| warning: false\nsharp_rd <- rdrobust(\n    y = senate$vote,\n    x = senate$margin,\n    h = 24.96899,\n    p = 3\n)\n\ntibble(\n    \"Estimate\" = pluck(sharp_rd, \"Estimate\")[1],\n    \"Se\" = pluck(sharp_rd, \"se\")[1],\n    \"P-Value\" = pluck(sharp_rd, \"pv\")[1]\n) %>%\n    print_kable(title = \"Sharp RD treatment effect\")\n```\n\n## Varying orders of polynomial regression\n\nModels with different bandwidth all support the same conclusion.\n\n```{r}\n#| message: false\n#| warning: false\nc(1:4) %>%\n    map(~ rdrobust(\n        y = senate$vote,\n        x = senate$margin,\n        p = .,\n        h = 24.96899\n    )) %>%\n    map_dfr(extract_se_es) %>%\n    mutate(\n        `Local-polynomial` = 1:4,\n        .before = 1\n    ) %>%\n    print_kable(\"Varying orders of polynomial regression\")\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"kable","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"show","code-overflow":"scroll","code-link":true,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":true,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../../scss/styles.css"],"highlight-style":"gruvbox","toc":true,"toc-depth":3,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.450","preview":{"port":5555,"browser":true,"watch-inputs":true,"navigate":true},"bibliography":["../../../bib/references.bib"],"csl":"../../../bib/chicago-author-date.csl","knitr":{"opts_chunk":{"warning":false,"message":false,"error":false}},"code-annotations":"hover","editor":"visual","theme":{"light":["flatly","../../../scss/light.scss"],"dark":["darkly","../../../scss/dark.scss"]},"author":[{"name":"Xinzhuo Huang","orcid":"0009-0007-6448-5114","email":"xhuangcb@connect.ust.hk","affiliations":[{"name":"HKUST SOSC"}]}],"smooth-scroll":true,"code-block-bg":"#f5f5f5","code-block-border-left":"#E0E0E0","date-modified":"last-modified","toc-location":"right","link-citations":"yes","comments":{"giscus":{"repo":"xinzhuohkust/comments","theme":"light"},"hypothesis":{"theme":"clean"}},"title":"Causal Inference Practical Methods","date":"May 15, 2023","categories":["R","DiD","RD","IV","Causal Inference"],"description":"with R","feed":true,"cap-location":"bottom"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}