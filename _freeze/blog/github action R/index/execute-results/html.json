{
  "hash": "8197436df41edf495c4f30b86506a4a3",
  "result": {
    "markdown": "---\ntitle: \"Automatic Web Scraper\"\ndate: \"Nov 2, 2023\"\ncategories: [R, Web Scraping, Github Actionsgit ]\ndescription: \"using R and GitHub Actions\"\ncode-fold: show\nfeed: true\ncap-location: bottom\nexecute: \n  warning: false\n  message: false\ncitation: \n    author: Huang Xinzhuo\n---\n\n```{=html}\n<style>\nbody {text-align: justify}\n</style>\n```\n\n![](githubactions.png){fig-align=\"center\" width=\"300\"}\n\n\nLet's create a automatic web scraper using R and Github actions to scrape real-time Weibo hot searches (akin to Twitter).\n\n## Github Actions workflow\n\nSet up a GitHub Actions workflow to create a scheduled task that launches every 30 minutes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\non:\n  schedule:\n   - cron: '*/30 * * * *' \n\njobs:\n  update-report:\n    runs-on: ubuntu-latest\n    permissions:\n      contents: write\n    \n    steps:\n      - name: Set up R\n        uses: r-lib/actions/setup-r@v2\n        \n      - name: Check out repository\n        uses: actions/checkout@v3\n      \n      - uses: actions/cache@v3 # Cache packages so won't be compiled everytime job is run\n        with:\n          path: ~/.local/share/renv\n          key: ${{ runner.os }}-renv-${{ hashFiles('**/renv.lock') }}\n          restore-keys: |\n            ${{ runner.os }}-renv-\n\n      - name: Install packages\n        uses: r-lib/actions/setup-r-dependencies@v2\n        with:\n          packages: |\n            any::tidyverse\n            any::rio\n            any::rvest\n            any::httr2\n            any::jsonlite\n            any::pacman\n            \n      - name: Web Scraping\n        run: source(\"weibo_realtime.R\")\n        shell: Rscript {0}\n        \n      - name: Commit files\n        run: |\n          git config --local user.name actions-user\n          git config --local user.email \"actions@github.com\"\n          git add data/*\n          git commit -am \"GH ACTION Headlines $(date)\"\n          git push origin main\n        env:\n          REPO_KEY: ${{secrets.GITHUB_TOKEN}}\n          username: github-actions\n```\n:::\n\n\nDeploy this web scraper to GitHub, enabling it to automatically scrape Weibo hot searches.\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"pacman\")\np_load(tidyverse, httr2, rvest)\n\nget_hot_item <- possibly(\n  insistently(\n    \\() {\n      result <- \"sample_website\" %>%\n        request() %>%\n        req_timeout(1000) %>%\n        req_headers(\n          \"User-Agent\" = \"User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36\",\n          \"Cookie\" = \"SUB=_2AkMXxWiSf8NxqwFRmPoWz2nlbop1zwvEieKhmZlJJRMxHRl-yT9jqlAItRB6PEVGfTP09XmsX_7CR2H1OUv6b-f-1bJl;SUBP=0033WrSXqPxfM72-Ws9jqgMF55529P9D9WWENAjmKyIZz1AWjDi68mRw\"\n        ) %>%\n        req_retry(\n          max_tries = 5,\n          max_seconds = 60,\n          backoff = ~ 2\n        ) %>%\n        req_perform() %>%\n        pluck(\"body\") %>%\n        read_html() %>%\n        html_element(\"tbody\") %>%\n        html_table()\n      \n      return(result)\n    },\n    rate = rate_backoff(\n      pause_base = 3,\n      pause_cap = 60,\n      max_times = 3,\n      jitter = TRUE\n    ),\n    quiet = FALSE\n  ),\n  otherwise = \"error!\"\n)\n\nget_hot_item()\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<div class=\"datatables html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-62784b62f3f0251d66c7\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-62784b62f3f0251d66c7\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\",\"27\",\"28\",\"29\",\"30\",\"31\",\"32\",\"33\",\"34\",\"35\",\"36\",\"37\",\"38\",\"39\",\"40\",\"41\",\"42\",\"43\",\"44\",\"45\",\"46\",\"47\",\"48\",\"49\",\"50\"],[\"李克强同志遗体在京火化\",\"李克强同志生平\",\"李克强同志生平照片\",\"俄罗斯撤销全面禁止核试验条约\",\"一碗拌面里有199只手剥龙虾\",\"赴美失踪3个月中国女子遗骸疑似被找到\",\"3元钱已经买不到饮料了\",\"达美乐30分钟必达3年亏损9亿\",\"飞了36年空姐最后一班飞行哭着告别\",\"专家称彩礼理念不改婚姻制度要崩溃\",\"金鸡奖给周冬雨于适P了衣服\",\"新闻联播\",\"ELLE红毯内场\",\"张元英凌晨去运动\",\"真爱至上有望内地上映\",\"官方回应副市长与女同事暧昧\",\"秦岚 我们不缺住好酒店的经历\",\"香港房价暴跌给内地楼市敲响警钟\",\"辛巴抖音账号被封禁\",\"儿子假装生病邀请84岁母亲来家住\",\"柯佳嬿 哪一个老公\",\"遭家暴16次女子公开挂粪袋造口画面\",\"因男朋友妈妈一句话分手了\",\"肖战中美电视节获奖\",\"康师傅回应涨价\",\"4天婴儿被护士烫伤致后脑勺大片水肿\",\"女孩生日爷爷去世一空乘塞手写信安慰\",\"在现偶古偶反复爱上王鹤棣\",\"当老婆喜欢随身带大容量吸管杯\",\"成毅中美电视节获奖\",\"太上老君遇到他炼丹炉都省了\",\"今年的春节档电影\",\"长期不社交的结果\",\"其实没有什么隔辈亲\",\"治愈系恋人\",\"金晨 被演戏耽误的北舞校花\",\"杨紫范丞丞将录制hi6\",\"水管工捡到300克黄金上交意外破获盗窃案\",\"双十一华为小米一机难求\",\"NewJeans弘大校庆舞台\",\"董宇辉背书方法\",\"被papi酱的表情笑死\",\"江苏省考筛选什么人才\",\"杜华回关了没\",\"爱吃面的公主请试青椒鸡蛋拌面\",\"莲花楼长尾效应好强\",\"WBG晋级S13四强\",\"9岁男孩捡2岁女孩民警猛夸\",\"体育老师返聘心理老师劝学成功率达7成\",\"女子给大爷指路后每年都收到礼物\"],[\"1197918\",\"1031642\",\"993091\",\"988773\",\"976499\",\"906986\",\"743517\",\"685664\",\"532098\",\"357306\",\"355257\",\"348291\",\"343826\",\"338743\",\"336116\",\"331702\",\"326731\",\"323085\",\"310585\",\"299971\",\"292175\",\"265225\",\"255747\",\"221224\",\"217459\",\"215420\",\"198941\",\"197196\",\"183904\",\"183554\",\"183380\",\"182704\",\"174597\",\"173159\",\"173073\",\"159924\",\"152584\",\"150249\",\"149764\",\"147756\",\"144576\",\"140742\",\"127185\",\"126363\",\"126306\",\"124999\",\"124724\",\"117377\",\"117361\",\"115918\"]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>Search<\\/th>\\n      <th>Hot Index<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"orderable\":false,\"targets\":0}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/htmlwidgets-1.6.2/htmlwidgets.js\"></script>\r\n<link href=\"../../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/datatables-binding-0.29/datatables.js\"></script>\r\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\r\n<link href=\"../../site_libs/dt-core-1.13.4/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\r\n<link href=\"../../site_libs/dt-core-1.13.4/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/dt-core-1.13.4/js/jquery.dataTables.min.js\"></script>\r\n<link href=\"../../site_libs/crosstalk-1.2.0/css/crosstalk.min.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/crosstalk-1.2.0/js/crosstalk.min.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}